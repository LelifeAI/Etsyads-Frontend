<!DOCTYPE html>
<html lang="en">
<head>

<nav>
    <ul class="nav-bar">
        <li><a href="#" onclick="showSection('login-section')">Đăng Nhập/Đăng Ký</a></li>
        <li><a href="#" onclick="showSection('change-password-section')">Đổi Mật Khẩu</a></li>
        <li><a href="#" onclick="showSection('history-section'); renderHistoryChart();">Lịch Sử Phân Tích</a></li>
        <li><a href="#" onclick="logoutUser()" style="display: none;" id="logout">Đăng Xuất</a></li>
        <li><a href="#" onclick="showSection('admin-dashboard'); fetchUsers();">Admin Dashboard</a></li>
    </ul>
</nav>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeLife-Etsyads-AI</title>

    <!-- Chèn CSS từ thư mục static -->
	<link rel="stylesheet" href="/static/style.css">
        <script src="/static/js/script.js"></script>

    <style>
        body {
        	font-family: 'Arial', sans-serif;
       	 	background-color: #f4f4f9;
        	margin: 0;
        	padding: 0;
    }

    header {
        	background-color: #333;
        	color: white;
        	padding: 20px;
       	 	text-align: center;
    }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px auto;
            max-width: 1200px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .input-section, .result-section, .chart-section {
            margin-bottom: 20px;
            width: 100%;
        }
        .flex-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }
        .section-header {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #4CAF50;
        }
        label {
            display: block;
            margin: 10px 0 5px;
            font-weight: bold;
        }
        input[type="text"], input[type="number"], input[type="date"] {
            width: 80%;
            padding: 6px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        .button:hover {
            background-color: #45a049;
        }
        .results, .proposals {
            padding: 15px;
            background-color: #f1f1f1;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .chart-container {
            margin-top: 20px;
        }
        .chart {
            width: 100%;
            max-width: 500px;
            margin: auto;
        }
        .row {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            align-items: center;
        }
        .row label {
            flex: 1;
        }
        .row input {
            flex: 2;
        }

.threshold-inputs {
    display: flex;
    justify-content: space-around;
    flex-wrap: nowrap;
    gap: 10px;
}
.chart-section {
    margin-top: 20px;
    text-align: center;
}

.section-header {
    font-size: 1.5rem;
    color: #4CAF50;
    margin-bottom: 10px;
}

body {
    font-family: Arial, sans-serif;
    background-color: #f3f4f6;
    color: #333;
}

header {
    background-color: #4caf50;
    color: white;
    padding: 15px;
    text-align: center;
    font-size: 24px;
    font-weight: bold;
}

.container {
    background-color: white;
    border-radius: 10px;
    padding: 20px;
    max-width: 1200px;
    margin: 20px auto;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.input-section, .result-section, .chart-section {
    margin-bottom: 30px;
}

.button {
    background-color: #4caf50;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
}

.button:hover {
    background-color: #45a049;
}

.results, .proposals {
    background-color: #f9f9f9;
    border-radius: 8px;
    padding: 15px;
    margin-top: 10px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.chart-container {
    text-align: center;
    margin-top: 20px;
}

.flex-container {
    display: flex;
    justify-content: space-around;
    flex-wrap: wrap;
}

input[type="number"], input[type="text"] {
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
    width: calc(100% - 24px);
    margin-bottom: 10px;
    font-size: 16px;
}

.notification {
    background-color: #4caf50;
    color: white;
    padding: 15px;
    border-radius: 5px;
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    z-index: 1000;
}

#change-password-form {
    display: none;
}

#show-change-password-btn {
    display: block;
}

.show-form #change-password-form {
    display: block;
}

.nav-bar {
    	list-style-type: none;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #444;
}

.nav-bar li {
    	float: left;
}

.nav-bar a {
    color: white;
    text-decoration: none;
    font-weight: bold;
    font-size: 18px;
}

.nav-bar li a {
        display: block;
        color: white;
        text-align: center;
        padding: 14px 16px;
        text-decoration: none;
    }

    .nav-bar li a:hover {
        background-color: #575757;
    }

.nav-bar a:hover {
    text-decoration: underline;
}

.content-section {
        margin: 20px;
        padding: 20px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

input {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .button {
        background-color: #4CAF50;
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .button:hover {
        background-color: #45a049;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }

    table, th, td {
        border: 1px solid #ddd;
    }

    th, td {
        padding: 12px;
        text-align: left;
    }

    th {
        background-color: #f4f4f9;
    }

#login-section, #change-password-section {
    margin: 20px 0;
    padding: 20px;
    background-color: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}


    </style>
</head>
<body>

<header>
   <div id="notification" style="display: none;" class="notification">
    <p id="notification-message"></p>
</div>

    EtsyAds-AI - Công cụ Phân tích, Dự đoán, Đánh giá quảng Cáo trên Etsy bằng AI
</header>

<div class="container">
    <div class="input-section">
        <div class="section-header">Nhập Dữ Liệu Của Bạn Vào Các Ô Dưới </div>

<section id="login-section" class="content-section" style="display: none;">
    <div class="login-section">
        <h3>Đăng Nhập</h3>
        <label for="username">Tên Đăng Nhập:</label>
        <input type="text" id="username" placeholder="Nhập tên đăng nhập">
        <label for="password">Mật Khẩu:</label>
        <input type="password" id="password" placeholder="Nhập mật khẩu">
        <button class="button" onclick="loginUser()">Đăng Nhập</button>
        <button class="button" onclick="registerUser()">Đăng Ký</button>
    </div>
</section>

<section id="change-password-section" class="content-section" style="display:none;">
    <div class="auth-section">
        <h3>Đổi mật khẩu</h3>
        <label for="username">Tên người dùng:</label>
        <input type="text" id="username" placeholder="Nhập tên người dùng">
        <label for="old-password">Mật khẩu cũ:</label>
        <input type="password" id="old-password" placeholder="Nhập mật khẩu cũ">
        <label for="new-password">Mật khẩu mới:</label>
        <input type="password" id="new-password" placeholder="Nhập mật khẩu mới">
        <button onclick="changePassword()">Đổi mật khẩu</button>
    </div>
</section>

<section id="user-list-section" class="content-section" style="display:none;">
    <div id="user-list">
        <h3>Danh sách người dùng</h3>
        <ul id="users"></ul>
    </div>
</section>

<section id="admin-dashboard" class="content-section" style="display: none;">
    <h3>Admin Dashboard - Quản Lý Người Dùng</h3>
    <table id="user-table" border="1">
        <thead>
            <tr>
                <th>ID</th>
                <th>Tên Người Dùng</th>
                <th>Hành Động</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</section>


<section id="history-section" class="content-section" style="display: none;">
    <h3>Lịch Sử Phân Tích</h3>
    
    <!-- Thêm canvas cho biểu đồ -->
    <canvas id="historyChart" style="max-width: 100%; margin-bottom: 20px;"></canvas>
    
    <!-- Bảng dữ liệu phân tích -->
    <table id="history-table" border="1">
        <thead>
            <tr>
                <th>Thời Gian</th>
                <th>CTR (%)</th>
                <th>CR (%)</th>
                <th>CPP (USD)</th>
                <th>ROI (%)</th>
                <th>Fee Ads (%)</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <button class="button" onclick="deleteHistory()">Xóa Lịch Sử</button>
</section>


        <!-- Thời gian chạy ads -->
        <div class="row">
            <label>Thời gian chạy ads:</label>
            <div>
                <label for="start-date">Thời gian bắt đầu:</label>
                <input type="date" id="start-date" required>
            </div>
            <div>
                <label for="end-date">Thời gian kết thúc:</label>
                <input type="date" id="end-date" required>
            </div>
        </div>

        <!-- Các chỉ số quảng cáo -->
        <div class="row">
            <div>
                <label for="views">Lượt xem:</label>
                <input type="number" id="views" placeholder="Nhập số lượt xem">
            </div>
            <div>
                <label for="clicks">Lượt nhấp chuột:</label>
                <input type="number" id="clicks" placeholder="Nhập số lượt nhấp">
            </div>
            <div>
                <label for="orders">Đơn hàng:</label>
                <input type="number" id="orders" placeholder="Nhập số đơn hàng">
            </div>
            <div>
                <label for="revenue">Doanh thu (USD):</label>
                <input type="number" id="revenue" placeholder="Nhập doanh thu">
            </div>
            <div>
                <label for="spend">Chi phí quảng cáo (USD):</label>
                <input type="number" id="spend" placeholder="Nhập chi phí quảng cáo">
            </div>

        </div>

        <!-- Thời gian bán hàng -->
        <div class="row" style="margin-top: 20px;">
            <label>Thời gian bán hàng:</label>
            <div>
                <label for="sales-start-date">Thời gian bắt đầu:</label>
                <input type="date" id="sales-start-date" required>
            </div>
            <div>
                <label for="sales-end-date">Thời gian kết thúc:</label>
                <input type="date" id="sales-end-date" required>
            </div>
        </div>

        <!-- Các chỉ số bán hàng -->
        <div class="row">
            <div>
                <label for="sales">Doanh thu bán hàng (USD):</label>
                <input type="number" id="sales" placeholder="Sales">
            </div>
            <div>
                <label for="marketing">Chi phí Marketing (USD):</label>
                <input type="number" id="marketing" placeholder="Marketing">
            </div>
            <div>
                <label for="fees">Phí giao dịch (USD):</label>
                <input type="number" id="fees" placeholder="Phí">
            </div>
        </div>


<!-- Ngưỡng Giá Trị Trung Bình (Tuỳ Chọn) -->
<div class="threshold-section">
    <h3>Ngưỡng Giá Trị Trung Bình (Tuỳ Chọn)</h3>
    <div class="threshold-inputs">
        <div>
            <label for="ctr-threshold">CTR (%):</label>
            <input type="number" id="ctr-threshold" placeholder="2" value="2">
        </div>
        <div>
            <label for="cr-threshold">CR (%):</label>
            <input type="number" id="cr-threshold" placeholder="2.5" value="2.5">
        </div>
        <div>
            <label for="cpp-threshold">CPP (USD):</label>
            <input type="number" id="cpp-threshold" placeholder="10" value="10">
        </div>
        <div>
            <label for="fee-ads-threshold">Fee Ads (%):</label>
            <input type="number" id="fee-ads-threshold" placeholder="20" value="20">
        </div>
        <div>
            <label for="roi-threshold">ROI (%):</label>
            <input type="number" id="roi-threshold" placeholder="75" value="75">
        </div>
    </div>
</div>

<button class="button" onclick="analyzeData()">Phân tích</button>
    </div>

<div class="result-section">
    <h3 class="section-header">Kết Quả Phân Tích</h3>
    <div id="analysis-results" class="results">
        Chưa có dữ liệu phân tích.
    </div>

        <div class="section-header">Đề Xuất Hành Động</div>
        <div class="proposals">
            <p id="proposals">Các đề xuất sẽ hiển thị ở đây...</p>
        </div>
    </div>

<div class="action-buttons">
    <button id="save-history" onclick="saveHistory()">Lưu Kết Quả</button>
</div>


  <div class="chart-section">
    <h3 class="section-header">Biểu Đồ So Sánh</h3>
    <div class="chart-container">
        <canvas id="comparison-chart" class="chart" style="max-width: 800px; margin: auto;"></canvas>
    </div>
</div>

    <div class="flex-container">
        <canvas id="chart-ctr" class="chart"></canvas>
        <canvas id="chart-cr" class="chart"></canvas>
        <canvas id="chart-cpp" class="chart"></canvas>
        <canvas id="chart-fee" class="chart"></canvas>
        <canvas id="chart-roi" class="chart"></canvas>
        <canvas id="historyChart"></canvas>
    </div>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const API_URL = "http://127.0.0.1:8000";

//Hiển thị thông báo
function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    const messageElement = document.getElementById('notification-message');
    
    messageElement.textContent = message;
    notification.style.backgroundColor = type === 'success' ? '#4caf50' : '#f44336';
    notification.style.display = 'block';

    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

// Hàm đăng ký người dùng
async function registerUser() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();

    if (!username || !password) {
        showNotification("Vui lòng nhập đầy đủ thông tin!", "error");
        return;
    }

    try {
        const response = await fetch(`${API_URL}/register/`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password })
        });

        if (response.ok) {
            showNotification("Đăng ký thành công! Hãy đăng nhập.", "success");

            // Ẩn phần Đăng Ký
            document.getElementById('login-section').style.display = 'none';
        } else {
            const result = await response.json();
            showNotification(`Lỗi: ${result.detail}`, "error");
        }
    } catch (error) {
        console.error("Lỗi khi đăng ký:", error);
        showNotification("Lỗi kết nối. Vui lòng thử lại.", "error");
    }
}

// Hàm đăng nhập người dùng
async function loginUser() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();

    if (!username || !password) {
        showNotification("Vui lòng nhập đầy đủ thông tin!", "error");
        return;
    }

    try {
        const response = await fetch(`${API_URL}/login/`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password })
        });

        if (response.ok) {
            const result = await response.json();
            localStorage.setItem("accessToken", result.access_token);  // Lưu token vào localStorage
            showNotification("Đăng nhập thành công!", "success");

            // Ẩn form Đăng Nhập
            document.getElementById('login-section').style.display = 'none';

            // Hiển thị nút Đăng Xuất
            document.getElementById('logout').style.display = 'block';
        } else {
            const errorData = await response.json();
            showNotification(`Lỗi: ${errorData.detail}`, "error");
        }
    } catch (error) {
        console.error("Lỗi khi đăng nhập:", error);
        showNotification("Lỗi kết nối. Vui lòng thử lại.", "error");
    }
}


async function changePassword() {
    const username = document.getElementById('username').value;
    const oldPassword = document.getElementById('old-password').value;
    const newPassword = document.getElementById('new-password').value;

    if (!username || !oldPassword || !newPassword) {
        showNotification("Vui lòng nhập đầy đủ thông tin!", "error");
        return;
    }

    try {
        const response = await fetch(`${API_URL}/change_password/`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, old_password: oldPassword, new_password: newPassword }),
        });

        if (response.ok) {
            showNotification("Đổi mật khẩu thành công!", "success");

            // Ẩn phần Đổi Mật Khẩu
            document.getElementById('change-password-section').style.display = 'none';
        } else {
            alert("Lỗi khi đổi mật khẩu.");
        }
    } catch (error) {
        console.error("Lỗi khi đổi mật khẩu:", error);
        alert("Lỗi kết nối. Vui lòng thử lại.");
    }
}

//lấy danh sách người dùng
async function getUsers() {
    try {
        const response = await fetch('/users/');
        const users = await response.json();

        if (Array.isArray(users)) {
            users.forEach(user => {
                console.log(user);
            });
        } else {
            console.error('Dữ liệu không phải là mảng:', users);
        }
    } catch (error) {
        console.error('Lỗi khi lấy dữ liệu người dùng:', error);
    }
}


const element = document.getElementById('some-element');
if (element) {
    element.style.display = 'block';
}

function logoutUser() {
    const token = localStorage.getItem("accessToken");

    if (!token) {
        showNotification("Bạn chưa đăng nhập!", "error");
        return;
    }

//lấy danh sách người dùng
async function fetchUsers() {
    const token = localStorage.getItem("accessToken");
    if (!token) {
        showNotification("Vui lòng đăng nhập!", "error");
        return;
    }

    try {
        const response = await fetch(`${API_URL}/users/`, {
            method: "GET",
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (response.ok) {
            const users = await response.json();
            const userTable = document.querySelector("#user-table tbody");
            userTable.innerHTML = "";

            users.forEach(user => {
                const row = `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td><button onclick="deleteUser(${user.id})">Xóa</button></td>
                    </tr>
                `;
                userTable.insertAdjacentHTML('beforeend', row);
            });
        } else {
            const errorData = await response.json();
            showNotification(`Lỗi: ${errorData.detail}`, "error");
        }
    } catch (error) {
        console.error("Lỗi khi tải danh sách người dùng:", error);
        showNotification("Lỗi kết nối. Vui lòng thử lại.", "error");
    }
}


// gửi yêu cầu xóa người dùng qua API
async function deleteUser(userId) {
    const token = localStorage.getItem("accessToken");
    if (!token) {
        showNotification("Vui lòng đăng nhập!", "error");
        return;
    }

    if (!confirm("Bạn có chắc chắn muốn xóa người dùng này?")) return;

    try {
        const response = await fetch(`${API_URL}/users/${userId}`, {
            method: "DELETE",
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (response.ok) {
            showNotification("Xóa người dùng thành công!", "success");
            fetchUsers();  // Làm mới danh sách sau khi xóa
        } else {
            showNotification("Lỗi khi xóa người dùng.", "error");
        }
    } catch (error) {
        console.error("Lỗi khi xóa người dùng:", error);
        showNotification("Lỗi kết nối. Vui lòng thử lại.", "error");
    }
}


    // Gọi API để đăng xuất (nếu backend có hỗ trợ)
    fetch(`${API_URL}/logout/`, { method: "POST", headers: { "Authorization": `Bearer ${token}` } })
        .then(response => {
            if (response.ok) {
                localStorage.removeItem("accessToken");
                showNotification("Đã đăng xuất thành công!", "success");

                // Hiển thị lại form Đăng Nhập
                document.getElementById('login-section').style.display = 'block';
                document.querySelectorAll('.content-section').forEach(section => {
                    section.style.display = 'none';
                });
            } else {
                showNotification("Lỗi khi đăng xuất!", "error");
            }
        })
        .catch(error => {
            console.error("Lỗi khi đăng xuất:", error);
            showNotification("Lỗi kết nối. Vui lòng thử lại.", "error");
        });
}


//điều khiển hiển thị các section
function showSection(sectionId) {
    const sections = document.querySelectorAll('.content-section');
    sections.forEach(section => {
        section.style.display = 'none';
    });

    const activeSection = document.getElementById(sectionId);
    if (activeSection) {
        activeSection.style.display = 'block';
    }
}


const charts = {};
let chartInstances = [];
let comparisonChart = null;

// Kiểm tra trạng thái đăng nhập khi tải trang
document.addEventListener("DOMContentLoaded", async () => {
    await refreshAccessToken();

    const token = localStorage.getItem("accessToken");
    if (token) {
        document.getElementById('logout').style.display = 'block';
        document.getElementById('login-section').style.display = 'none';
        showNotification("Đã đăng nhập", "success");
    }
});

//Gọi hàm này khi người dùng nhấp vào tab Lịch Sử Phân Tích
document.addEventListener("DOMContentLoaded", () => {
    console.log("Trang đã tải xong. Không hiển thị form mặc định.");
    document.querySelector('a[href="#history-section"]').addEventListener('click', fetchHistory);
});

// Hiển thị nút Đăng Xuất nếu người dùng đã đăng nhập
    document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("accessToken");
        if (token) {
            document.querySelector('a[href="#logout"]').style.display = 'block';
        } else {
            document.querySelector('a[href="#logout"]').style.display = 'none';
        }
    });

// Hàm lấy lịch sử phân tích
async function fetchHistory() {
    try {
        const response = await fetch(`${API_URL}/history/`);
        if (!response.ok) {
            throw new Error(`Lỗi khi tải lịch sử: ${response.status}`);
        }
        const history = await response.json();

        console.log("Dữ liệu nhận từ API:", history); // Thêm log kiểm tra

        const historyTable = document.querySelector("#history-table tbody");
        historyTable.innerHTML = "";

        if (history.length === 0) {
            historyTable.innerHTML = "<tr><td colspan='6'>Không có dữ liệu phân tích.</td></tr>";
            return;
        }

        history.forEach(entry => {
            const row = `
                <tr>
                    <td>${new Date(entry.timestamp).toLocaleString()}</td>
                    <td>${entry.ctr.toFixed(2)}%</td>
                    <td>${entry.cr.toFixed(2)}%</td>
                    <td>$${entry.cpp.toFixed(2)}</td>
                    <td>${entry.roi.toFixed(2)}%</td>
                    <td>${entry.fee_ads.toFixed(2)}%</td>
                </tr>
            `;
            historyTable.insertAdjacentHTML('beforeend', row);
        });

        console.log("Đã hiển thị dữ liệu lên bảng.");
    } catch (error) {
        console.error("Lỗi khi tải lịch sử:", error);
    }
}


// Định nghĩa hàm deleteHistory
   async function deleteHistory() {
    if (!confirm("Bạn có chắc chắn muốn xóa toàn bộ lịch sử?")) return;

    try {
        const response = await fetch(`${API_URL}/history/`, { method: "DELETE" });

        if (response.ok) {
            showNotification("Lịch sử đã được xóa thành công!", "success");
            await fetchHistory();  // Làm mới bảng sau khi xóa
        } else {
            showNotification("Lỗi khi xóa lịch sử.", "error");
        }
    } catch (error) {
        console.error("Lỗi khi xóa lịch sử:", error);
        showNotification("Lỗi kết nối. Vui lòng thử lại.", "error");
    }
}


// Thêm Hàm JavaScript Lưu Lịch Sử
async function saveHistory() {
        console.log("Hàm saveHistory() được gọi");  // Kiểm tra log

const thresholds = {
    ctr: parseFloat(document.getElementById('ctr-threshold').value) || 2,
    cr: parseFloat(document.getElementById('cr-threshold').value) || 2.5,
    cpp: parseFloat(document.getElementById('cpp-threshold').value) || 10,
    fee_ads: parseFloat(document.getElementById('fee-ads-threshold').value) || 20,
    roi: parseFloat(document.getElementById('roi-threshold').value) || 75
};

console.log("Ngưỡng tùy chỉnh được nhập:", thresholds);


        const analysisResults = {
            ctr: parseFloat(document.querySelector('#analysis-results p:nth-child(1)').textContent.split(": ")[1]) || 0,
            cr: parseFloat(document.querySelector('#analysis-results p:nth-child(2)').textContent.split(": ")[1]) || 0,
            cpp: parseFloat(document.querySelector('#analysis-results p:nth-child(3)').textContent.split(": ")[1].substring(1)) || 0,
            fee_ads: parseFloat(document.querySelector('#analysis-results p:nth-child(5)').textContent.split(": ")[1]) || 0,
            roi: parseFloat(document.querySelector('#analysis-results p:nth-child(4)').textContent.split(": ")[1]) || 0,
        };

        try {
            const response = await fetch(`${API_URL}/history/`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(analysisResults)
            });

            if (response.ok) {
                alert("Kết quả đã được lưu!");
                fetchHistory();
            } else {
                throw new Error(`Lỗi khi lưu lịch sử: ${response.status}`);
            }
        } catch (error) {
            console.error("Lỗi khi lưu lịch sử:", error);
        }
    }

async function getRecommendation(data) {
    try {
        const response = await fetch('/recommend/', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        console.log("Recommendation from API:", result.recommendation);
        document.getElementById("recommendation-section").innerText = result.recommendation;
    } catch (error) {
        console.error("Lỗi khi gửi yêu cầu:", error);
    }
}


async function renderHistoryChart() {
    const response = await fetch(`${API_URL}/history/`);
    const history = await response.json();

    // Hủy biểu đồ cũ nếu đã tồn tại
    const existingChart = Chart.getChart("historyChart");
    if (existingChart) {
        existingChart.destroy();
    }

    // Lấy dữ liệu từ API
    const labels = history.map(entry => new Date(entry.timestamp).toLocaleString());
    const ctrData = history.map(entry => entry.ctr);
    const crData = history.map(entry => entry.cr);
    const cppData = history.map(entry => entry.cpp);
    const roiData = history.map(entry => entry.roi);

    // Vẽ biểu đồ với nhiều dataset
    const ctx = document.getElementById('historyChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'CTR (%)',
                    data: ctrData,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderWidth: 1
                },
                {
                    label: 'CR (%)',
                    data: crData,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderWidth: 1
                },
                {
                    label: 'CPP (USD)',
                    data: cppData,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderWidth: 1
                },
                {
                    label: 'ROI (%)',
                    data: roiData,
                    borderColor: 'rgba(255, 206, 86, 1)',
                    backgroundColor: 'rgba(255, 206, 86, 0.2)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
}


async function refreshAccessToken() {
    const refreshToken = localStorage.getItem("refreshToken");
    if (!refreshToken) return;

    try {
        const response = await fetch(`${API_URL}/refresh/`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ refresh_token: refreshToken })
        });

        if (response.ok) {
            const result = await response.json();
            localStorage.setItem("accessToken", result.access_token);
            showNotification("Token đã được làm mới!", "success");
        } else {
            showNotification("Lỗi khi làm mới token.", "error");
        }
    } catch (error) {
        console.error("Lỗi khi làm mới token:", error);
        showNotification("Lỗi kết nối. Vui lòng thử lại.", "error");
    }
}


async function analyzeData() {
    const data = {
        views: parseInt(document.getElementById('views').value) || 0,
        clicks: parseInt(document.getElementById('clicks').value) || 0,
        orders: parseInt(document.getElementById('orders').value) || 0,
        revenue: parseFloat(document.getElementById('revenue').value) || 0,
        spend: parseFloat(document.getElementById('spend').value) || 0,
        sales: parseFloat(document.getElementById('sales').value) || 0,
        marketing: parseFloat(document.getElementById('marketing').value) || 0,
        fees: parseFloat(document.getElementById('fees').value) || 0,
        thresholds: {
            ctr: parseFloat(document.getElementById('ctr-threshold').value) || 2,
            cr: parseFloat(document.getElementById('cr-threshold').value) || 2.5,
            cpp: parseFloat(document.getElementById('cpp-threshold').value) || 10,
            fee_ads: parseFloat(document.getElementById('fee-ads-threshold').value) || 20,
            roi: parseFloat(document.getElementById('roi-threshold').value) || 75
        }
    };

    console.log("Dữ liệu gửi đi:", data);

    try {
        const response = await fetch('http://127.0.0.1:8000/analyze/', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            console.error(`Lỗi từ backend: ${response.statusText}`);
            alert(`Lỗi từ backend: ${response.statusText}`);
            return;
        }

        const result = await response.json();
        console.log("Kết quả từ backend:", result);
        showNotification("Phân tích dữ liệu thành công!");
       
       // Cập nhật biểu đồ so sánh
       updateChart(result.analysis, data.thresholds);

        // Hiển thị Kết Quả Phân Tích
        const analysisResults = result.analysis;
        if (analysisResults) {
            document.getElementById('analysis-results').innerHTML = `
                <p>CTR: ${analysisResults.ctr.toFixed(2)}%</p>
                <p>CR: ${analysisResults.cr.toFixed(2)}%</p>
                <p>CPP: $${analysisResults.cpp.toFixed(2)}</p>
                <p>ROI: ${analysisResults.roi.toFixed(2)}%</p>
                <p>Fee Ads: ${analysisResults.fee_ads.toFixed(2)}%</p>
            `;
        } else {
            document.getElementById('analysis-results').innerHTML = "<p>Không có dữ liệu phân tích.</p>";
        }

        // Hiển thị đề xuất hành động
       if (result.recommendation) {
    const proposalsHTML = result.recommendation
        .split('<br>')
        .map(proposal => `<p>${proposal.trim()}</p>`)
        .join('');
    document.querySelector('.proposals').innerHTML = proposalsHTML;
} else {
    document.querySelector('.proposals').innerHTML = "<p>Không có đề xuất nào.</p>";
}


        //  Cập nhật biểu đồ
        updateCharts({
            ctr: { current: analysisResults.ctr, average: data.thresholds.ctr },
            cr: { current: analysisResults.cr, average: data.thresholds.cr },
            cpp: { current: analysisResults.cpp, average: data.thresholds.cpp },
            fee_ads: { current: analysisResults.fee_ads, average: data.thresholds.fee_ads },
            roi: { current: analysisResults.roi, average: data.thresholds.roi }
        });

    } catch (error) {
        console.error("Lỗi khi kết nối tới backend:", error);

        if (error.message.includes("Failed to fetch")) {
            alert("Không thể kết nối tới backend. Vui lòng kiểm tra kết nối.");
        } else if (error.message) {
            alert(`Đã xảy ra lỗi: ${error.message}`);
        } else {
            console.error("Lỗi khác:", error);
        }
    }
}




async function saveAnalysis() {
    const data = {
        views: parseInt(document.getElementById('views').value) || 0,
        clicks: parseInt(document.getElementById('clicks').value) || 0,
        orders: parseInt(document.getElementById('orders').value) || 0,
        revenue: parseFloat(document.getElementById('revenue').value) || 0,
        spend: parseFloat(document.getElementById('spend').value) || 0,
        sales: parseFloat(document.getElementById('sales').value) || 0,
        marketing: parseFloat(document.getElementById('marketing').value) || 0,
        fees: parseFloat(document.getElementById('fees').value) || 0
    };

    try {
        const response = await fetch(`${API_URL}/analysis/`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            alert("Dữ liệu đã được lưu thành công!");
        } else {
            alert("Lỗi khi lưu dữ liệu.");
        }

    } catch (error) {
        console.error("Lỗi lưu dữ liệu:", error);
    }
}


// Hàm vẽ biểu đồ

function renderChart(canvasId, label, data, backgroundColor) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
        console.error(`Không tìm thấy phần tử canvas với ID: ${canvasId}`);
        return;
    }

    const ctx = canvas.getContext('2d');

    // Phá hủy biểu đồ cũ nếu tồn tại
    if (charts[canvasId]) {
        charts[canvasId].destroy();
    }

    // Tạo biểu đồ mới và lưu vào charts
    charts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Hiện tại', 'Ngưỡng Trung Bình'],
            datasets: [{
                label: label,
                data: data,
                backgroundColor: backgroundColor,
            }],
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: `So Sánh ${label}` },
            },
        },
    });
}

function updateChart(currentData, averageData) {
    const canvas = document.getElementById("comparison-chart");
    if (!canvas) {
        console.error("Không tìm thấy phần tử canvas.");
        return;
    }

    const ctx = canvas.getContext("2d");

    // Phá hủy biểu đồ cũ nếu tồn tại
    if (comparisonChart) {
        comparisonChart.destroy();
    }

    // Tạo biểu đồ mới với dữ liệu ngưỡng tùy chỉnh
    comparisonChart = new Chart(ctx, {
        type: "bar",
        data: {
            labels: ["CTR", "CR", "CPP", "ROI", "Fee Ads"],
            datasets: [
                {
                    label: "Hiện Tại",
                    data: [currentData.ctr, currentData.cr, currentData.cpp, currentData.roi, currentData.fee_ads],
                    backgroundColor: "rgba(75, 192, 192, 0.6)",
                    borderColor: "rgba(75, 192, 192, 1)",
                    borderWidth: 1
                },
                {
                    label: "Ngưỡng Trung Bình",
                    data: [averageData.ctr, averageData.cr, averageData.cpp, averageData.roi, averageData.fee_ads],
                    backgroundColor: "rgba(153, 102, 255, 0.6)",
                    borderColor: "rgba(153, 102, 255, 1)",
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: "top" },
                title: { display: true, text: "So Sánh Chỉ Số Bán hàng Hiện tại và Ngưỡng Trung Bình Của Bạn" }
            }
        }
    });
}


     // Cập nhật các biểu đồ tại đây
    function updateCharts(chartsData) {
    document.querySelector('.section-header').innerText = 'So Sánh Chỉ Số';
    // Kiểm tra dữ liệu truyền vào
    console.log("Dữ liệu biểu đồ:", chartsData);

    renderChart('chart-ctr', 'CTR (%)', [chartsData.ctr.current, chartsData.ctr.average], ['#4CAF50', '#FF5722']);
    renderChart('chart-cr', 'CR (%)', [chartsData.cr.current, chartsData.cr.average], ['#2196F3', '#FFC107']);
    renderChart('chart-cpp', 'CPP (USD)', [chartsData.cpp.current, chartsData.cpp.average], ['#9C27B0', '#3F51B5']);
    renderChart('chart-roi', 'ROI (%)', [chartsData.roi.current, chartsData.roi.average], ['#E91E63', '#03A9F4']);
    renderChart('chart-fee', 'Fee Ads (%)', [chartsData.fee_ads.current, chartsData.fee_ads.average], ['#03A9F4', '#FFC107']);


// Hàm gọi backend và hiển thị biểu đồ
// Cập nhật hiển thị kết quả phân tích



    }

</script>
<!-- Chèn JavaScript từ thư mục static -->
<script src="/static/script.js"></script>
</body>
</html>
